generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  BUYER
}

enum OrderStatus {
  DRAFT
  SUBMITTED
  APPROVED
  FULFILLED
  CANCELLED
}

enum ProductSource {
  MANUAL
  SUPPLIER
}

enum ExciseType {
  ML
  PRODUCT
}

enum SupplierApiType {
  CSV
  PRESTASHOP
}

enum DiscountType {
  PERCENT
  FIXED
}

enum RuleScope {
  ORDER
  PRODUCT
  CATEGORY
  BRAND
  SUPPLIER
  PARENT
}

enum ReturnStatus {
  PENDING
  HANDLED
}

enum MarketingCampaignStatus {
  DRAFT
  SCHEDULED
  SENT
  FAILED
}

model Company {
  id        String   @id @default(cuid())
  name      String
  vatNumber String?  @unique
  status    String   @default("PENDING")
  contactFirstName String?
  contactLastName  String?
  legalName        String?
  sdiCode          String?
  address          String?
  cap              String?
  city             String?
  province         String?
  phone            String?
  email            String?
  customerCode     String?
  pec              String?
  licenseNumber    String?
  cmnr             String?
  signNumber       String?
  adminVatNumber   String?
  createdAt DateTime @default(now())

  users  User[]
  orders Order[]
  returnRequests ReturnRequest[]
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(BUYER)
  approved     Boolean  @default(false)
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  ordersCreated Order[] @relation("OrderCreatedBy")
  goodsReceiptsCreated GoodsReceipt[] @relation("GoodsReceiptCreatedBy")
  returnRequests ReturnRequest[] @relation("ReturnRequestedBy")
  handledReturns ReturnRequest[] @relation("ReturnHandledBy")
  mailTemplates MailMarketingTemplate[]
  mailCampaigns MailMarketingCampaign[]
}

model Supplier {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  isPrimary   Boolean  @default(false)
  apiType     SupplierApiType @default(CSV)
  csvFullUrl  String?
  csvStockUrl String?
  apiBaseUrl  String?
  apiHost     String?
  apiKey      String?
  fieldMap    Json?
  createdAt   DateTime @default(now())

  supplierProducts SupplierProduct[]
  products         Product[]
}

model SupplierProduct {
  id           String   @id @default(cuid())
  supplierId   String
  supplierSku  String
  name         String?
  description  String?
  shortDescription String?
  brand        String?
  category     String?
  subcategory  String?
  categoryId   String?
  published    Boolean? @default(true)
  visibility   String?
  productType  String?
  parentSku    String?
  childSkus    Json?
  codicePl     String?
  mlProduct    Decimal? @db.Decimal(12, 3)
  nicotine     Decimal? @db.Decimal(12, 3)
  exciseMl     Decimal? @db.Decimal(12, 6)
  exciseProduct Decimal? @db.Decimal(12, 6)
  exciseTotal  Decimal? @db.Decimal(12, 6)
  taxRate      Decimal? @db.Decimal(6, 2)
  taxAmount    Decimal? @db.Decimal(12, 6)
  price        Decimal? @db.Decimal(12, 2)
  purchasePrice Decimal? @db.Decimal(12, 2)
  listPrice     Decimal? @db.Decimal(12, 2)
  discountPrice Decimal? @db.Decimal(12, 2)
  discountQty   Int?
  stockQty     Int?
  imageUrl     String?
  imageUrls    Json?
  barcode      String?
  raw          Json?
  createdAt    DateTime @default(now())
  lastSeenAt   DateTime @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id])
  categoryRef Category? @relation(fields: [categoryId], references: [id])

  @@unique([supplierId, supplierSku])
}

model Product {
  id          String        @id @default(cuid())
  sku         String        @unique
  name        String
  description String?
  shortDescription String?
  brand       String?
  category    String?
  subcategory String?
  categoryId  String?
  parentId    String?
  isParent    Boolean       @default(false)
  sellAsSingle Boolean      @default(true)
  isUnavailable Boolean     @default(false)
  published   Boolean?      @default(true)
  visibility  String?
  productType String?
  parentSku   String?
  childSkus   Json?
  relatedProductIds Json?
  parentSort Int      @default(0)
  codicePl    String?
  mlProduct   Decimal? @db.Decimal(12, 3)
  nicotine    Decimal? @db.Decimal(12, 3)
  exciseMl    Decimal? @db.Decimal(12, 6)
  exciseProduct Decimal? @db.Decimal(12, 6)
  exciseTotal Decimal? @db.Decimal(12, 6)
  taxRate     Decimal? @db.Decimal(6, 2)
  taxAmount   Decimal? @db.Decimal(12, 6)
  vatIncluded Boolean  @default(true)
  price       Decimal       @db.Decimal(12, 2)
  purchasePrice Decimal? @db.Decimal(12, 2)
  listPrice     Decimal? @db.Decimal(12, 2)
  discountPrice Decimal? @db.Decimal(12, 2)
  discountQty   Int?
  stockQty    Int           @default(0)
  imageUrl    String?
  imageUrls   Json?
  barcode     String?
  source      ProductSource @default(MANUAL)
  createdAt   DateTime      @default(now())

  sourceSupplierId String?
  sourceSupplier   Supplier? @relation(fields: [sourceSupplierId], references: [id])
  taxRateId   String?
  taxRateRef  TaxRate? @relation(fields: [taxRateId], references: [id])
  exciseRateId String?
  exciseRateRef ExciseRate? @relation(fields: [exciseRateId], references: [id])
  categoryRef      Category? @relation(fields: [categoryId], references: [id])
  parent           Product?  @relation("ProductParent", fields: [parentId], references: [id])
  children         Product[] @relation("ProductParent")
  images           ProductImage[]

  orderItems OrderItem[]
}

model TaxRate {
  id        String   @id @default(cuid())
  name      String
  rate      Decimal  @db.Decimal(6, 2)
  createdAt DateTime @default(now())
  products  Product[]
  internalInventoryItems InternalInventoryItem[]
}

model ExciseRate {
  id        String    @id @default(cuid())
  name      String
  type      ExciseType
  amount    Decimal   @db.Decimal(12, 6)
  createdAt DateTime  @default(now())
  products  Product[]
  internalInventoryItems InternalInventoryItem[]
}

model AppSetting {
  id              String   @id @default(cuid())
  vatRateDefault  Decimal? @db.Decimal(6, 2)
  exciseMlDefault Decimal? @db.Decimal(12, 6)
  exciseProductDefault Decimal? @db.Decimal(12, 6)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Brand {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
}

model Category {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  parentId  String?
  createdAt DateTime  @default(now())

  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")
  products Product[]
  supplierProducts SupplierProduct[]

  @@index([parentId])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

model Order {
  id         String      @id @default(cuid())
  status     OrderStatus @default(DRAFT)
  total      Decimal     @db.Decimal(12, 2)
  discountTotal Decimal? @db.Decimal(12, 2)
  createdAt  DateTime    @default(now())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdById String
  createdBy   User   @relation("OrderCreatedBy", fields: [createdById], references: [id])

  items OrderItem[]
}

model Discount {
  id        String       @id @default(cuid())
  name      String
  scope     RuleScope    @default(ORDER)
  target    String?
  type      DiscountType @default(PERCENT)
  value     Decimal      @db.Decimal(12, 4)
  active    Boolean      @default(true)
  startDate DateTime?
  endDate   DateTime?
  notes     String?
  createdAt DateTime     @default(now())
}

model DiscountRule {
  id          String       @id @default(cuid())
  name        String
  active      Boolean      @default(true)
  scope       RuleScope    @default(ORDER)
  target      String?
  type        DiscountType @default(PERCENT)
  value       Decimal      @db.Decimal(12, 4)
  maxDiscount Decimal?     @db.Decimal(12, 2)
  minQty      Int?
  minSpend    Decimal?     @db.Decimal(12, 2)
  stackable   Boolean      @default(false)
  priority    Int          @default(50)
  startDate   DateTime?
  endDate     DateTime?
  days        Json?
  timeFrom    String?
  timeTo      String?
  includeSkus String?
  excludeSkus String?
  notes       String?
  createdAt   DateTime     @default(now())
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  productId  String
  sku        String
  name       String
  qty        Int
  unitPrice  Decimal @db.Decimal(12, 2)
  lineTotal  Decimal @db.Decimal(12, 2)

  supplierId String?

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model ProductPrice {
  id        String  @id @default(cuid())
  companyId String
  productId String
  price     Decimal @db.Decimal(12, 2)

  @@unique([companyId, productId])
}

model ReturnRequest {
  id                 String       @id @default(cuid())
  orderNumber        String
  productName        String
  problemDescription String
  contactName        String?
  contactEmail       String?
  status             ReturnStatus @default(PENDING)
  createdAt          DateTime     @default(now())
  handledAt          DateTime?

  companyId  String?
  company    Company? @relation(fields: [companyId], references: [id])

  userId     String?
  user       User?    @relation("ReturnRequestedBy", fields: [userId], references: [id])

  handledById String?
  handledBy   User?    @relation("ReturnHandledBy", fields: [handledById], references: [id])

  images ReturnRequestImage[]
}

model ReturnRequestImage {
  id        String   @id @default(cuid())
  requestId String
  url       String
  createdAt DateTime @default(now())

  request ReturnRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
}

model MailMarketingTemplate {
  id        String   @id @default(cuid())
  name      String
  subject   String
  html      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String?
  createdBy   User? @relation(fields: [createdById], references: [id])

  campaigns MailMarketingCampaign[]
}

model MailMarketingCampaign {
  id        String   @id @default(cuid())
  name      String
  subject   String
  html      String
  listId    Int
  groupId   Int?
  status    MarketingCampaignStatus @default(DRAFT)
  audienceType String @default("ALL_ACTIVE")
  audienceCompanyIds Json?
  recipientCount Int @default(0)
  sentCount Int @default(0)
  failedCount Int @default(0)
  mailupEmailId Int?
  mailupSendId  String?
  scheduledAt DateTime?
  sentAt      DateTime?
  lastError   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  templateId String?
  template   MailMarketingTemplate? @relation(fields: [templateId], references: [id])

  createdById String?
  createdBy   User? @relation(fields: [createdById], references: [id])
}

model InternalInventoryItem {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  description String?
  shortDescription String?
  brand       String?
  category    String?
  subcategory String?
  barcode     String?
  nicotine    Decimal? @db.Decimal(12, 3)
  mlProduct   Decimal? @db.Decimal(12, 3)
  purchasePrice Decimal? @db.Decimal(12, 2)
  listPrice     Decimal? @db.Decimal(12, 2)
  price         Decimal? @db.Decimal(12, 2)
  stockQty    Int      @default(0)
  taxRateId   String?
  exciseRateId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  taxRateRef    TaxRate?    @relation(fields: [taxRateId], references: [id])
  exciseRateRef ExciseRate? @relation(fields: [exciseRateId], references: [id])
  receiptLines  GoodsReceiptLine[]
}

model GoodsReceipt {
  id           String   @id @default(cuid())
  receiptNo    String   @unique
  supplierName String?
  reference    String?
  notes        String?
  receivedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  createdById  String?

  createdBy User? @relation("GoodsReceiptCreatedBy", fields: [createdById], references: [id])
  lines     GoodsReceiptLine[]
}

model GoodsReceiptLine {
  id         String   @id @default(cuid())
  receiptId  String
  itemId     String
  sku        String
  name       String
  qty        Int
  unitCost   Decimal? @db.Decimal(12, 2)
  unitPrice  Decimal? @db.Decimal(12, 2)
  lineNote   String?
  createdAt  DateTime @default(now())

  receipt GoodsReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  item    InternalInventoryItem @relation(fields: [itemId], references: [id])

  @@index([receiptId])
  @@index([itemId])
}
