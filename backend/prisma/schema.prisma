generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  BUYER
}

enum OrderStatus {
  DRAFT
  SUBMITTED
  APPROVED
  FULFILLED
  CANCELLED
}

enum ProductSource {
  MANUAL
  SUPPLIER
}

enum ExciseType {
  ML
  PRODUCT
}

enum SupplierApiType {
  CSV
  PRESTASHOP
}

enum DiscountType {
  PERCENT
  FIXED
}

enum RuleScope {
  ORDER
  PRODUCT
  CATEGORY
  BRAND
  SUPPLIER
  PARENT
}

model Company {
  id        String   @id @default(cuid())
  name      String
  vatNumber String?  @unique
  status    String   @default("PENDING")
  contactFirstName String?
  contactLastName  String?
  legalName        String?
  sdiCode          String?
  address          String?
  cap              String?
  city             String?
  province         String?
  phone            String?
  email            String?
  customerCode     String?
  pec              String?
  licenseNumber    String?
  cmnr             String?
  signNumber       String?
  adminVatNumber   String?
  createdAt DateTime @default(now())

  users  User[]
  orders Order[]
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(BUYER)
  approved     Boolean  @default(false)
  createdAt    DateTime @default(now())

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  ordersCreated Order[] @relation("OrderCreatedBy")
}

model Supplier {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  isPrimary   Boolean  @default(false)
  apiType     SupplierApiType @default(CSV)
  csvFullUrl  String?
  csvStockUrl String?
  apiBaseUrl  String?
  apiHost     String?
  apiKey      String?
  fieldMap    Json?
  createdAt   DateTime @default(now())

  supplierProducts SupplierProduct[]
  products         Product[]
}

model SupplierProduct {
  id           String   @id @default(cuid())
  supplierId   String
  supplierSku  String
  name         String?
  description  String?
  shortDescription String?
  brand        String?
  category     String?
  subcategory  String?
  categoryId   String?
  published    Boolean? @default(true)
  visibility   String?
  productType  String?
  parentSku    String?
  childSkus    Json?
  codicePl     String?
  mlProduct    Decimal? @db.Decimal(12, 3)
  nicotine     Decimal? @db.Decimal(12, 3)
  exciseMl     Decimal? @db.Decimal(12, 6)
  exciseProduct Decimal? @db.Decimal(12, 6)
  exciseTotal  Decimal? @db.Decimal(12, 6)
  taxRate      Decimal? @db.Decimal(6, 2)
  taxAmount    Decimal? @db.Decimal(12, 6)
  price        Decimal? @db.Decimal(12, 2)
  purchasePrice Decimal? @db.Decimal(12, 2)
  listPrice     Decimal? @db.Decimal(12, 2)
  discountPrice Decimal? @db.Decimal(12, 2)
  discountQty   Int?
  stockQty     Int?
  imageUrl     String?
  imageUrls    Json?
  barcode      String?
  raw          Json?
  lastSeenAt   DateTime @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id])
  categoryRef Category? @relation(fields: [categoryId], references: [id])

  @@unique([supplierId, supplierSku])
}

model Product {
  id          String        @id @default(cuid())
  sku         String        @unique
  name        String
  description String?
  shortDescription String?
  brand       String?
  category    String?
  subcategory String?
  categoryId  String?
  parentId    String?
  isParent    Boolean       @default(false)
  isUnavailable Boolean     @default(false)
  published   Boolean?      @default(true)
  visibility  String?
  productType String?
  parentSku   String?
  childSkus   Json?
  parentSort Int      @default(0)
  codicePl    String?
  mlProduct   Decimal? @db.Decimal(12, 3)
  nicotine    Decimal? @db.Decimal(12, 3)
  exciseMl    Decimal? @db.Decimal(12, 6)
  exciseProduct Decimal? @db.Decimal(12, 6)
  exciseTotal Decimal? @db.Decimal(12, 6)
  taxRate     Decimal? @db.Decimal(6, 2)
  taxAmount   Decimal? @db.Decimal(12, 6)
  vatIncluded Boolean  @default(true)
  price       Decimal       @db.Decimal(12, 2)
  purchasePrice Decimal? @db.Decimal(12, 2)
  listPrice     Decimal? @db.Decimal(12, 2)
  discountPrice Decimal? @db.Decimal(12, 2)
  discountQty   Int?
  stockQty    Int           @default(0)
  imageUrl    String?
  imageUrls   Json?
  barcode     String?
  source      ProductSource @default(MANUAL)
  createdAt   DateTime      @default(now())

  sourceSupplierId String?
  sourceSupplier   Supplier? @relation(fields: [sourceSupplierId], references: [id])
  taxRateId   String?
  taxRateRef  TaxRate? @relation(fields: [taxRateId], references: [id])
  exciseRateId String?
  exciseRateRef ExciseRate? @relation(fields: [exciseRateId], references: [id])
  categoryRef      Category? @relation(fields: [categoryId], references: [id])
  parent           Product?  @relation("ProductParent", fields: [parentId], references: [id])
  children         Product[] @relation("ProductParent")
  images           ProductImage[]

  orderItems OrderItem[]
}

model TaxRate {
  id        String   @id @default(cuid())
  name      String
  rate      Decimal  @db.Decimal(6, 2)
  createdAt DateTime @default(now())
  products  Product[]
}

model ExciseRate {
  id        String    @id @default(cuid())
  name      String
  type      ExciseType
  amount    Decimal   @db.Decimal(12, 6)
  createdAt DateTime  @default(now())
  products  Product[]
}

model AppSetting {
  id              String   @id @default(cuid())
  vatRateDefault  Decimal? @db.Decimal(6, 2)
  exciseMlDefault Decimal? @db.Decimal(12, 6)
  exciseProductDefault Decimal? @db.Decimal(12, 6)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  parentId  String?
  createdAt DateTime  @default(now())

  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")
  products Product[]
  supplierProducts SupplierProduct[]

  @@index([parentId])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

model Order {
  id         String      @id @default(cuid())
  status     OrderStatus @default(DRAFT)
  total      Decimal     @db.Decimal(12, 2)
  discountTotal Decimal? @db.Decimal(12, 2)
  createdAt  DateTime    @default(now())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdById String
  createdBy   User   @relation("OrderCreatedBy", fields: [createdById], references: [id])

  items OrderItem[]
}

model Discount {
  id        String       @id @default(cuid())
  name      String
  scope     RuleScope    @default(ORDER)
  target    String?
  type      DiscountType @default(PERCENT)
  value     Decimal      @db.Decimal(12, 4)
  active    Boolean      @default(true)
  startDate DateTime?
  endDate   DateTime?
  notes     String?
  createdAt DateTime     @default(now())
}

model DiscountRule {
  id          String       @id @default(cuid())
  name        String
  active      Boolean      @default(true)
  scope       RuleScope    @default(ORDER)
  target      String?
  type        DiscountType @default(PERCENT)
  value       Decimal      @db.Decimal(12, 4)
  maxDiscount Decimal?     @db.Decimal(12, 2)
  minQty      Int?
  minSpend    Decimal?     @db.Decimal(12, 2)
  stackable   Boolean      @default(false)
  priority    Int          @default(50)
  startDate   DateTime?
  endDate     DateTime?
  days        Json?
  timeFrom    String?
  timeTo      String?
  includeSkus String?
  excludeSkus String?
  notes       String?
  createdAt   DateTime     @default(now())
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  productId  String
  sku        String
  name       String
  qty        Int
  unitPrice  Decimal @db.Decimal(12, 2)
  lineTotal  Decimal @db.Decimal(12, 2)

  supplierId String?

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model ProductPrice {
  id        String  @id @default(cuid())
  companyId String
  productId String
  price     Decimal @db.Decimal(12, 2)

  @@unique([companyId, productId])
}
