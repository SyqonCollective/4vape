generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  BUYER
}

enum OrderStatus {
  DRAFT
  SUBMITTED
  APPROVED
  FULFILLED
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CARD
  COD
  OTHER
}

enum ProductSource {
  MANUAL
  SUPPLIER
}

enum ExciseType {
  ML
  PRODUCT
}

enum SupplierApiType {
  CSV
  PRESTASHOP
}

enum DiscountType {
  PERCENT
  FIXED
}

enum RuleScope {
  ORDER
  PRODUCT
  CATEGORY
  BRAND
  SUPPLIER
  PARENT
}

enum ReturnStatus {
  PENDING
  HANDLED
}

enum TreasurySourceType {
  FISCAL_INVOICE
  GOODS_RECEIPT
  EXPENSE_INVOICE
}

enum ShipmentStatus {
  DRAFT
  READY
  SHIPPED
  DELIVERED
  EXCEPTION
}

enum MarketingCampaignStatus {
  DRAFT
  SCHEDULED
  SENT
  FAILED
}

model Company {
  id               String   @id @default(cuid())
  name             String
  vatNumber        String?  @unique
  status           String   @default("PENDING")
  groupName        String?
  contactFirstName String?
  contactLastName  String?
  legalName        String?
  sdiCode          String?
  address          String?
  cap              String?
  city             String?
  province         String?
  phone            String?
  email            String?
  customerCode     String?
  pec              String?
  licenseNumber    String?
  cmnr             String?
  signNumber       String?
  adminVatNumber   String?
  createdAt        DateTime @default(now())

  users          User[]
  orders         Order[]
  fiscalInvoices FiscalInvoice[]
  returnRequests ReturnRequest[]
  productPrices  ProductPrice[]
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  clerkUserId  String?   @unique
  passwordHash String
  role         UserRole  @default(BUYER)
  approved     Boolean   @default(false)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  ordersCreated        Order[]                 @relation("OrderCreatedBy")
  goodsReceiptsCreated GoodsReceipt[]          @relation("GoodsReceiptCreatedBy")
  returnRequests       ReturnRequest[]         @relation("ReturnRequestedBy")
  handledReturns       ReturnRequest[]         @relation("ReturnHandledBy")
  mailTemplates        MailMarketingTemplate[]
  mailCampaigns        MailMarketingCampaign[]
}

model Supplier {
  id          String          @id @default(cuid())
  name        String
  code        String          @unique
  legalName   String?
  vatNumber   String?
  taxCode     String?
  sdiCode     String?
  pec         String?
  address     String?
  cap         String?
  city        String?
  province    String?
  country     String?
  phone       String?
  email       String?
  isPrimary   Boolean         @default(false)
  apiType     SupplierApiType @default(CSV)
  csvFullUrl  String?
  csvStockUrl String?
  apiBaseUrl  String?
  apiHost     String?
  apiKey      String?
  fieldMap    Json?
  createdAt   DateTime        @default(now())

  supplierProducts SupplierProduct[]
  products         Product[]
  goodsReceipts    GoodsReceipt[]
}

model SupplierProduct {
  id               String   @id @default(cuid())
  supplierId       String
  supplierSku      String
  name             String?
  description      String?
  shortDescription String?
  brand            String?
  category         String?
  subcategory      String?
  categoryId       String?
  published        Boolean? @default(true)
  visibility       String?
  productType      String?
  parentSku        String?
  childSkus        Json?
  codicePl         String?
  mlProduct        Decimal? @db.Decimal(12, 3)
  nicotine         Decimal? @db.Decimal(12, 3)
  exciseMl         Decimal? @db.Decimal(12, 6)
  exciseProduct    Decimal? @db.Decimal(12, 6)
  exciseTotal      Decimal? @db.Decimal(12, 6)
  taxRate          Decimal? @db.Decimal(6, 2)
  taxAmount        Decimal? @db.Decimal(12, 6)
  price            Decimal? @db.Decimal(12, 2)
  purchasePrice    Decimal? @db.Decimal(12, 2)
  listPrice        Decimal? @db.Decimal(12, 2)
  discountPrice    Decimal? @db.Decimal(12, 2)
  discountQty      Int?
  stockQty         Int?
  imageUrl         String?
  imageUrls        Json?
  barcode          String?
  raw              Json?
  createdAt        DateTime @default(now())
  lastSeenAt       DateTime @default(now())

  supplier    Supplier  @relation(fields: [supplierId], references: [id])
  categoryRef Category? @relation(fields: [categoryId], references: [id])

  @@unique([supplierId, supplierSku])
}

model Product {
  id                String        @id @default(cuid())
  sku               String        @unique
  name              String
  description       String?
  shortDescription  String?
  brand             String?
  category          String?
  subcategory       String?
  categoryIds       Json?
  subcategories     Json?
  aroma             String?
  categoryId        String?
  parentId          String?
  isParent          Boolean       @default(false)
  sellAsSingle      Boolean       @default(true)
  isUnavailable     Boolean       @default(false)
  published         Boolean?      @default(true)
  visibility        String?
  productType       String?
  parentSku         String?
  childSkus         Json?
  relatedProductIds Json?
  parentSort        Int           @default(0)
  codicePl          String?
  mlProduct         Decimal?      @db.Decimal(12, 3)
  nicotine          Decimal?      @db.Decimal(12, 3)
  exciseMl          Decimal?      @db.Decimal(12, 6)
  exciseProduct     Decimal?      @db.Decimal(12, 6)
  exciseTotal       Decimal?      @db.Decimal(12, 6)
  taxRate           Decimal?      @db.Decimal(6, 2)
  taxAmount         Decimal?      @db.Decimal(12, 6)
  vatIncluded       Boolean       @default(true)
  price             Decimal       @db.Decimal(12, 2)
  purchasePrice     Decimal?      @db.Decimal(12, 2)
  listPrice         Decimal?      @db.Decimal(12, 2)
  discountPrice     Decimal?      @db.Decimal(12, 2)
  discountQty       Int?
  stockQty          Int           @default(0)
  imageUrl          String?
  imageUrls         Json?
  barcode           String?
  source            ProductSource @default(MANUAL)
  createdAt         DateTime      @default(now())

  sourceSupplierId String?
  sourceSupplier   Supplier?      @relation(fields: [sourceSupplierId], references: [id])
  taxRateId        String?
  taxRateRef       TaxRate?       @relation(fields: [taxRateId], references: [id])
  exciseRateId     String?
  exciseRateRef    ExciseRate?    @relation(fields: [exciseRateId], references: [id])
  categoryRef      Category?      @relation(fields: [categoryId], references: [id])
  parent           Product?       @relation("ProductParent", fields: [parentId], references: [id])
  children         Product[]      @relation("ProductParent")
  images           ProductImage[]

  orderItems    OrderItem[]
  companyPrices ProductPrice[]
  fiscalLines   FiscalInvoiceLine[]
  bundleItems   ProductBundleItem[]
}

model TaxRate {
  id                     String                  @id @default(cuid())
  name                   String
  rate                   Decimal                 @db.Decimal(6, 2)
  createdAt              DateTime                @default(now())
  products               Product[]
  internalInventoryItems InternalInventoryItem[]
}

model ExciseRate {
  id                     String                  @id @default(cuid())
  name                   String
  type                   ExciseType
  amount                 Decimal                 @db.Decimal(12, 6)
  createdAt              DateTime                @default(now())
  products               Product[]
  internalInventoryItems InternalInventoryItem[]
}

model AppSetting {
  id                   String   @id @default(cuid())
  vatRateDefault       Decimal? @db.Decimal(6, 2)
  exciseMlDefault      Decimal? @db.Decimal(12, 6)
  exciseProductDefault Decimal? @db.Decimal(12, 6)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Brand {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
}

model Category {
  id          String   @id @default(cuid())
  name        String
  description String?
  slug        String   @unique
  parentId    String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  parent           Category?         @relation("CategoryTree", fields: [parentId], references: [id])
  children         Category[]        @relation("CategoryTree")
  products         Product[]
  supplierProducts SupplierProduct[]

  @@index([parentId])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

model Order {
  id            String        @id @default(cuid())
  orderNumber   Int           @unique @default(autoincrement())
  status        OrderStatus   @default(DRAFT)
  paymentMethod PaymentMethod @default(BANK_TRANSFER)
  total         Decimal       @db.Decimal(12, 2)
  discountTotal Decimal?      @db.Decimal(12, 2)
  createdAt     DateTime      @default(now())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdById String
  createdBy   User   @relation("OrderCreatedBy", fields: [createdById], references: [id])

  items         OrderItem[]
  fiscalInvoice FiscalInvoice?
  shipment      Shipment?
}

model FiscalInvoice {
  id             String   @id @default(cuid())
  invoiceNumber  String   @unique
  issuedAt       DateTime
  orderId        String?  @unique
  companyId      String
  exerciseNumber String?
  cmnr           String?
  signNumber     String?
  legalName      String?
  city           String?
  province       String?
  adminVatNumber String?
  createdAt      DateTime @default(now())

  order   Order?   @relation(fields: [orderId], references: [id])
  company Company  @relation(fields: [companyId], references: [id])
  lines   FiscalInvoiceLine[]

  @@index([issuedAt])
  @@index([companyId])
}

model FiscalInvoiceLine {
  id          String   @id @default(cuid())
  invoiceId   String
  productId   String?
  sku         String
  productName String
  codicePl    String?
  mlProduct   Decimal? @db.Decimal(12, 3)
  nicotine    Decimal? @db.Decimal(12, 3)
  qty         Int
  unitGross   Decimal  @db.Decimal(12, 4)
  exciseUnit  Decimal  @db.Decimal(12, 6)
  exciseTotal Decimal  @db.Decimal(12, 6)
  vatTotal    Decimal  @default(0) @db.Decimal(12, 6)
  createdAt   DateTime @default(now())

  invoice FiscalInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product?      @relation(fields: [productId], references: [id])

  @@index([invoiceId])
  @@index([productId])
  @@index([sku])
}

model Discount {
  id        String       @id @default(cuid())
  name      String
  code      String?      @unique
  scope     RuleScope    @default(ORDER)
  target    String?
  type      DiscountType @default(PERCENT)
  value     Decimal      @db.Decimal(12, 4)
  minSpend  Decimal?     @db.Decimal(12, 2)
  active    Boolean      @default(true)
  startDate DateTime?
  endDate   DateTime?
  notes     String?
  createdAt DateTime     @default(now())
}

model DiscountRule {
  id          String       @id @default(cuid())
  name        String
  active      Boolean      @default(true)
  scope       RuleScope    @default(ORDER)
  target      String?
  type        DiscountType @default(PERCENT)
  value       Decimal      @db.Decimal(12, 4)
  maxDiscount Decimal?     @db.Decimal(12, 2)
  minQty      Int?
  minSpend    Decimal?     @db.Decimal(12, 2)
  stackable   Boolean      @default(false)
  priority    Int          @default(50)
  startDate   DateTime?
  endDate     DateTime?
  days        Json?
  timeFrom    String?
  timeTo      String?
  includeSkus String?
  excludeSkus String?
  notes       String?
  createdAt   DateTime     @default(now())
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  sku       String
  name      String
  qty       Int
  unitPrice Decimal @db.Decimal(12, 2)
  lineTotal Decimal @db.Decimal(12, 2)

  supplierId String?

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model ProductPrice {
  id        String  @id @default(cuid())
  companyId String
  productId String
  price     Decimal @db.Decimal(12, 2)

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId])
}

model ReturnRequest {
  id                 String       @id @default(cuid())
  orderNumber        String
  productName        String
  problemDescription String
  contactName        String?
  contactEmail       String?
  status             ReturnStatus @default(PENDING)
  createdAt          DateTime     @default(now())
  handledAt          DateTime?

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  userId String?
  user   User?   @relation("ReturnRequestedBy", fields: [userId], references: [id])

  handledById String?
  handledBy   User?   @relation("ReturnHandledBy", fields: [handledById], references: [id])

  images ReturnRequestImage[]
}

model ReturnRequestImage {
  id        String   @id @default(cuid())
  requestId String
  url       String
  createdAt DateTime @default(now())

  request ReturnRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
}

model MailMarketingTemplate {
  id        String   @id @default(cuid())
  name      String
  subject   String
  html      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  campaigns MailMarketingCampaign[]
}

model MailMarketingCampaign {
  id                 String                  @id @default(cuid())
  name               String
  subject            String
  html               String
  listId             Int
  groupId            Int?
  status             MarketingCampaignStatus @default(DRAFT)
  audienceType       String                  @default("ALL_ACTIVE")
  audienceCompanyIds Json?
  recipientCount     Int                     @default(0)
  sentCount          Int                     @default(0)
  failedCount        Int                     @default(0)
  mailupEmailId      Int?
  mailupSendId       String?
  scheduledAt        DateTime?
  sentAt             DateTime?
  lastError          String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt

  templateId String?
  template   MailMarketingTemplate? @relation(fields: [templateId], references: [id])

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])
}

model InternalInventoryItem {
  id               String   @id @default(cuid())
  sku              String   @unique
  name             String
  description      String?
  shortDescription String?
  brand            String?
  category         String?
  subcategory      String?
  barcode          String?
  nicotine         Decimal? @db.Decimal(12, 3)
  mlProduct        Decimal? @db.Decimal(12, 3)
  purchasePrice    Decimal? @db.Decimal(12, 2)
  listPrice        Decimal? @db.Decimal(12, 2)
  price            Decimal? @db.Decimal(12, 2)
  stockQty         Int      @default(0)
  taxRateId        String?
  exciseRateId     String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  taxRateRef    TaxRate?           @relation(fields: [taxRateId], references: [id])
  exciseRateRef ExciseRate?        @relation(fields: [exciseRateId], references: [id])
  receiptLines  GoodsReceiptLine[]
}

model GoodsReceipt {
  id           String   @id @default(cuid())
  receiptNo    String   @unique
  supplierName String?
  reference    String?
  notes        String?
  receivedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  createdById  String?
  supplierId   String?

  createdBy User?              @relation("GoodsReceiptCreatedBy", fields: [createdById], references: [id])
  supplier  Supplier?          @relation(fields: [supplierId], references: [id])
  lines     GoodsReceiptLine[]
}

model GoodsReceiptLine {
  id        String   @id @default(cuid())
  receiptId String
  itemId    String
  sku       String
  name      String
  qty       Int
  unitCost  Decimal? @db.Decimal(12, 2)
  unitPrice Decimal? @db.Decimal(12, 2)
  lineNote  String?
  createdAt DateTime @default(now())

  receipt GoodsReceipt          @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  item    InternalInventoryItem @relation(fields: [itemId], references: [id])

  @@index([receiptId])
  @@index([itemId])
}

model ExpenseInvoice {
  id          String   @id @default(cuid())
  invoiceNo   String
  expenseDate DateTime
  supplier    String?
  supplierId  String?
  category    String?
  amountNet   Decimal  @db.Decimal(12, 2)
  vat         Decimal  @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)
  notes       String?
  createdAt   DateTime @default(now())
}

model TreasurySettlement {
  id         String             @id @default(cuid())
  sourceType TreasurySourceType
  sourceId   String
  paid       Boolean            @default(false)
  paidAt     DateTime?
  updatedAt  DateTime           @updatedAt

  @@unique([sourceType, sourceId])
  @@index([sourceType, sourceId])
}

model ProductBundle {
  id          String   @id @default(cuid())
  name        String
  bundlePrice Decimal  @db.Decimal(12, 2)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items ProductBundleItem[]
}

model ProductBundleItem {
  id        String   @id @default(cuid())
  bundleId  String
  productId String
  qty       Int      @default(1)
  createdAt DateTime @default(now())

  bundle  ProductBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product Product       @relation(fields: [productId], references: [id])

  @@unique([bundleId, productId])
  @@index([bundleId])
  @@index([productId])
}

model Shipment {
  id           String         @id @default(cuid())
  orderId       String?        @unique
  fiscalInvoiceId String?
  carrier      String?
  trackingCode String?
  status       ShipmentStatus @default(DRAFT)
  shippingDate DateTime?
  deliveredAt  DateTime?
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  order Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([shippingDate])
}
